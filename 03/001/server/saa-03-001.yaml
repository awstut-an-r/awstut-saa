AWSTemplateFormatVersion: 2010-09-09

Parameters:
  TemplateBucketName:
    Type: String
    Default: awstut-bucket
    
  Prefix:
    Type: String
    Default: saa-03-001
    
  GeoRestrictionLocation:
    Type: String
    Default: JP
    
  HTTPPort:
    Type: Number
    Default: 80
  

Resources:
  VPCStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "https://${TemplateBucketName}.s3.${AWS::Region}.amazonaws.com/${Prefix}/${Prefix}-vpc.yaml"
      Parameters:
        #AvailabilityZone1: a
        #AvailabilityZone2: d
        CidrIp: 10.0.1.0/24
        #CidrIp1: 10.0.1.0/24
        #CidrIp2: 10.0.2.0/24
        #CidrIp3: 10.0.3.0/24
        #CidrIp4: 10.0.4.0/24
        HTTPPort: !Ref HTTPPort
        #HTTPSPort: !Ref HTTPSPort
        Prefix: !Ref Prefix
        VPCCidrBlock: 10.0.0.0/16
        
  EC2Stack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - VPCStack
    Properties:
      TemplateURL: !Sub "https://${TemplateBucketName}.s3.${AWS::Region}.amazonaws.com/${Prefix}/${Prefix}-ec2.yaml"
      Parameters:
        ImageId: /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-arm64-gp2
        InstanceSecurityGroup: !GetAtt VPCStack.Outputs.InstanceSecurityGroup
        InstanceType: t4g.nano
        Prefix: !Ref Prefix
        PublicSubnet: !GetAtt VPCStack.Outputs.PublicSubnet
        
  CloudFrontStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - EC2Stack
    Properties:
      TemplateURL: !Sub "https://${TemplateBucketName}.s3.${AWS::Region}.amazonaws.com/${Prefix}/${Prefix}-cloudfront.yaml"
      Parameters:
        CacheTTL: 60
        GeoRestrictionLocation: !Ref GeoRestrictionLocation
        HTTPPort: !Ref HTTPPort
        #OriginDomainName: !GetAtt ALBStack.Outputs.ALBDNSName
        InstancePublicDnsName: !GetAtt EC2Stack.Outputs.InstancePublicDnsName
        Prefix: !Ref Prefix